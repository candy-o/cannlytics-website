<!doctype html>
<html>

  <!-- https://developers.google.com/maps/documentation/javascript/geocoding -->
  <!-- https://stackoverflow.com/questions/5984179/javascript-geocoding-from-address-to-latitude-and-longitude-numbers-not-working -->

  <!-- Let people search by analysis and compare prices -->

  <!-- Lab Locator -->
  <div class="container lab-locator py-4">

    <!-- Introduction -->
    <div class="col-md-6">
      <h2 class="display-5 text-dark fw-bold my-2">Find your lab</h2>
      <p class="h6 double-line mb-3">
        Locate your cannabis testing laboratory, browse analyses, and
        engage with like-minded scientists around the world.
      </p>
    </div>
    
    <!-- TODO: Map of labs with toggle of Cannlytics labs -->
    <div id="map" style="height:400px;width:100%;"></div>

  </div>

  <!-- Lab Locator JavaScript -->
  <script type="text/javascript">
    var script = document.createElement('script');
    var apiKey = ''; // FIXME: Get from Firestore.
    // var apiKey = {{ api_key }};
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
    script.defer = true;
    window.initMap = function() {

      // Draw map.
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 4,
        center: new google.maps.LatLng(39.8283, -98.5795),
        mapTypeId: google.maps.MapTypeId.ROADMAP
      });

      // Initialize infowindows.
      var labs = {{ locations|safe }}
      console.log('Labs:', labs);
      //var labs = {{ locations|safe }};
      var infowindow = new google.maps.InfoWindow();
      var marker, i;
      for (i = 0; i < labs.length; i++) {
        var lab = labs[i];
        marker = new google.maps.Marker({
          position: new google.maps.LatLng(lab[1], lab[2]),
          map: map
        });
        google.maps.event.addListener(marker, 'click', (function(marker, i) {
          return function() {
            infowindow.setContent(`<a href="./labs/lab-a">${lab[0]}</a>`);
            infowindow.open(map, marker);
          }
        })(marker, i));
      }

    };
    document.head.appendChild(script);
  </script>

</html>